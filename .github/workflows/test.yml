name: build-easi
on:
  - push

jobs:
  easi:
    name: easi
    runs-on: ubuntu-24.04
    container: ${{ matrix.compiler.container }}
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - cc: gcc-13
            cxx: g++-13
            fc: gfortran-13
            container: seissol/gha-cpu:davschneller-gpu-image
          - cc: clang-19
            cxx: clang++-19
            fc: gfortran-13 # TODO?
            container: seissol/gha-cpu:davschneller-gpu-image
          - cc: icx
            cxx: icpx
            fc: ifx
            container: seissol/gha-gpu-intel:davschneller-gpu-image
          - cc: nvc
            cxx: nvc++
            fc: nvfortran
            container: seissol/gha-gpu-nvhpc:davschneller-gpu-image
    steps:
      - name: checkout-easi
        uses: actions/checkout@v4

      - id: build
        name: build-easi
        run: |
          git config --global --add safe.directory '*'
          git submodule update --init
          mkdir build && cd build

          # TODO: change to `-Wall -Werror` at some point
          EXTRA_FLAGS="-Wall"

          export CFLAGS="${EXTRA_FLAGS} ${CFLAGS}"
          export CXXFLAGS="${EXTRA_FLAGS} ${CXXFLAGS}"
          export FFLAGS="${EXTRA_FLAGS} ${FFLAGS}"

          export CC=${{matrix.compiler.cc}}
          export CXX=${{matrix.compiler.cxx}}
          export FC=${{matrix.compiler.fc}}

          cmake .. -GNinja -DIMPALAJIT=OFF -DTESTING=ON -DASAGI=ON -DLUA=ON -DEASICUBE=OFF
          ninja

      - name: test-easi
        if: steps.build.outcome == 'success'
        run: |
          cd build
          # start with MPI for ASAGI, and NVHPC
          export OMPI_ALLOW_RUN_AS_ROOT=1
          export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
          mpirun -n 1 ctest --rerun-failed --output-on-failure
